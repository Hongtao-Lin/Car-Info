<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>汽车评论可视化</title>
    <script type="text/javascript" src="js/d3.js"></script>
</head>
<style type="text/css">
body {
	color: gray;
}
svg {
	position: absolute;
	top: calc(50% - 300px);
	left: calc(50% - 500px);	
}
.node {
  stroke: #fff;
  stroke-width: 1.5px;
  cursor:pointer;
}
.center_text {
  fill: #000;
  font-size: 12px;
  cursor: pointer;
  position: relative;
  pointer-events: none;
  
 }
g title {
	position: absolute;
}
.color_tag > div {
	display: inline-block;
}
div.tag_detail {
	position: absolute;
	top: 0;
	width: 250px;
	background: rgba(237,237,237,0.9);
	padding: 30px;
	max-height: 400px;
	display: none;
}
.tag_detail h4 {
	position: relative;
	display: inline-block;
	margin: 0;
	padding: 0;
	padding-bottom: 10px;
}
.cancel_button {
	float: right;
}
div.comment_item {
	padding-right: 3px;
	/*margin-bottom: 15px;*/
}
div.comment_detail {
	max-height: 300px;
	overflow-y: auto;
}
</style>
<body>

<script type="text/javascript">	
	var width = 960;
    var height = 600;
	
	// 0 for center, 1 for good, 2 for bad, 3 for neutral;
	var color = ["#bedaf4","red","#54a4ee","gray"];
	
	var color_tag = d3.select("body").append("div")
		.attr("class","color_tag")
		.selectAll("div")
		.data(color.slice(1, color.length))
		.enter()
		.append("div")
		.append("span")
		.attr("class","color")
		.style({"display": "inline-block", "background": function(d) {return d;}, "width": "20px", "height": "20px", "border-radius": "20px", "vertical-align": "middle", "border": "2px black solid"})
		.each(function(d, i) {
			var text = document.createElement("span");
			var name = function(i) {
				if (i == 0)
					return "正面评价";
				if (i == 1)
					return "负面评价";
				else
					return "中性评价";
			};
			text.innerHTML = name(i);
			text.style.marginRight = "5px";
			text.style.marginLeft = "3px";
			this.parentNode.appendChild(text);
		});

	var svg = d3.select("body").append("svg")
		.attr("width", width)
		.attr("height", height);
	
	var force = d3.layout.force()
		.linkDistance(190)
		.size([width, height]);	
	var graph = <%=graph%>;
    // var graph = graph%>;
	// d3.json(j, function(error, graph) {
		var nodes = [], links = [];
		// int i = 0;
		var series = graph.series;
		series["fixed"] = true;
		series["x"] = width/2;
		series["y"] = height/2;
		nodes.push(graph.series);
		// create links;
		for (var i = 0; i < graph.nodes.length; ++i) {
			nodes.push(graph.nodes[i]);
			links.push({"source":i+1,"target":0});
		}
		d3.select("body").append("div")
			.attr("class","hot")
			.append("span")
			.text("热度:")
			.style({"margin-right":"3px"})
			.each(function() {
				var hot_num = graph.series.hot;
				var hot = document.createElement("span");
				hot.innerHTML = hot_num;
				this.parentNode.appendChild(hot);
				hot.style.color = "red";
			});
		// var stack = d3.layout.stack()
		// 	.
		force.nodes(nodes)
			.links(links)
			.start()
			.gravity(0)
			// .charge(0);
			.charge( function(d) { 
				if (d.group == 0) {return 0;} else {return 200;} 
			;});
	  
		
		var link = svg.selectAll(".link")
		  .data(links)
		  .enter()
		  .append("line")
		  .attr("class", "link")
		  .attr("stroke",function(d) {return color[d.source.group]})
		  .attr("stroke-opacity","0.8")
		  .style("stroke-width",2);
		  
		var node = svg.selectAll(".node")
		  .data(nodes)
		  .enter()
		  .append("g");
		var circle = node.append("circle")
		  .attr("class", "node")
		  .attr("r",function(d){ 
		  	if(d.group == 0) {
		  		return 100;
		  	} else {
		  		return Math.sqrt(d.weight*300) + Math.random()*5 + 5;
		  	} 
		  })
		  .style("fill", function(d) { return color[d.group]; })
		  .on("mouseenter", function(d){
		  	if (d.group == 0)
		  		return;
		  	d3.select(this)
		  		// .transition()
		  		// .duration(100)
		  		.attr("r", 1.2*this.r.baseVal.value);
		  })
		  .on("mouseout", function(d) {
		  	if (d.group == 0)
		  		return;
		  	d3.select(this)
		  		.attr("r", this.r.baseVal.value/1.2);
		  })
		  .on("click", function(d) {
		  	if (d.group == 0) {
		  		return;
		  	} else {
		  	}
		  });
		
		var node_text = node.append("text")
		  .attr("class","nodetext")
		  // .attr("dy", function(d) )
		  .style("text-anchor", "middle")
		  .text(function(d) { return d.name; });
	
		var center_node = node[0][0];
		force.on("tick", function() {
			node.attr("transform", function(d){ 
				d.x = d.x < d.r/2 ? d.r/2 : d.x;  
				d.x = d.x + d.r/2 > width ? width - d.r/2 : d.x; 
				d.y = d.y < d.r/2 ? d.r/2 : d.y;  
				d.y = d.y + d.r/2 > height ? height - d.r/2 : d.y;
				return "translate("+d.x+"," + d.y + ")";
			});
			// console.log(node.attr("x"))
			node_text.attr("top", function(d){
				if (d.id == 0)
					return;
				var dx = d.x - center_node.__data__.x > 0 ? 1 : -1;
				var dy = d.y - center_node.__data__.y > 0 ? 1.4 : -1;
				var r = circle[0][d.id].getAttribute("r");
				d3.select(this).attr("dx", dx*r*1.2)
				d3.select(this).attr("dy", dy*r*1.2)
				 // = dx + center_node.__data__.x;
			});
			link.attr("x1", function(d) { return d.source.x; })
				.attr("y1", function(d) { return d.source.y; })
				.attr("x2", function(d) { return d.target.x; })
				.attr("y2", function(d) { return d.target.y; });
			force.tick();
		});
		// when click, dynamically create the detail div.
		// note that the order of nodes and comments should be the same.
		node.on("click", function(d) {
			if (d.group != 0) {
				var comment_list = graph.comments[d.id-1].comments;
				var tag_detail = document.getElementsByClassName("tag_detail")[0];
				var comment_item, comment_tmp;
				var comment_detail = document.getElementsByClassName("comment_detail")[0];
				comment_detail.innerHTML = null;
				for (var i = 0; i < comment_list.length; ++i) {
					if (i == 0) {
						var comment = '\
							<div class="comment_item"> \
							<span style="position:relative; left:0; margin-top:10px"></span> \
							<span style="float: right; margin-right: 3px;"></span> \
							<p></p> \
							<hr style="margin-bottom: 0px;"> </div> \
						';
						comment_detail.innerHTML = comment;
						comment_item = document.getElementsByClassName("comment_item")[0];
						comment_tmp = comment_item;
						comment_item.getElementsByTagName("span")[0].innerHTML = comment_list[i].from;
						comment_item.getElementsByTagName("span")[1].innerHTML = comment_list[i].date;
						comment_item.getElementsByTagName("p")[0].innerHTML = comment_list[i].content;
					}
					else {
						comment_tmp = comment_item.cloneNode(true);
						comment_tmp.getElementsByTagName("span")[0].innerHTML = comment_list[i].from;
						comment_tmp.getElementsByTagName("span")[1].innerHTML = comment_list[i].date;
						comment_tmp.getElementsByTagName("p")[0].innerHTML = comment_list[i].content;
						comment_item.parentNode.appendChild(comment_tmp);
					}
				}
				tag_detail.style.display = "block";
				tag_detail.getElementsByTagName("h4")[0].innerHTML = d.name;
				console.log(d3.select(this)[0][0].__data__)
				tag_detail.style.left = (d3.select(this)[0][0].__data__.x) + "px";
				tag_detail.style.top = (d3.select(this)[0][0].__data__.y) + "px";
			}
		});
		// var 
		var comment_div = document.createElement("div");
		comment_div.className = "tag_detail";
		var content = ' \
			<h4></h4> \
			<span class="cancel_button" style="cursor:pointer;"><img src="image/tag-close.png" /></span> \
			<div class="comment_detail"></div> \
		';
		comment_div.innerHTML =  content;
		document.body.appendChild(comment_div);
		var g = document.getElementsByTagName("g");
		for (var i = 1; i < circle[0].length; ++i) {
			g[i].onclick = function(e) {
				var ev = e || window.event;
		        if(ev.stopPropagation){
		            ev.stopPropagation();
		        }
		        else if(window.event){
		            window.event.cancelBubble = true;
		        }
			}
		}
		document.getElementsByClassName("cancel_button")[0].onclick = function(e) {
			this.parentNode.style.display = "none";
			var ev = e || window.event;
	        if(ev.stopPropagation){
	            ev.stopPropagation();
	        }
	        else if(window.event){
	            window.event.cancelBubble = true;
	        }
		};
		document.onclick = function() {
			var tag_detail = document.getElementsByClassName("tag_detail")[0];
			if (tag_detail.style.display == "block") 
				tag_detail.style.display = "none";
		};
// });
			
</script>



</body>
</html>